# 稀疏光流算法集成说明

## 概述

本项目已成功集成稀疏光流算法，实现了基于Lucas-Kanade方法的运动检测和跟踪功能。系统现在支持两种跟踪模式：

1. **色块检测跟踪**：传统的颜色阈值检测方法
2. **光流运动跟踪**：基于稀疏光流的运动估计方法
3. **混合跟踪模式**：优先使用色块检测，当没有检测到目标色块时自动切换到光流跟踪

## 算法特性

### 稀疏光流算法
- **算法类型**：Lucas-Kanade光流法
- **特征检测**：Harris角点检测器
- **跟踪点数**：最多50个特征点
- **窗口大小**：5x5像素
- **适用场景**：运动物体跟踪、相机稳定、运动补偿

### 性能优化
- **内存优化**：使用ESP32的PSRAM进行大内存分配
- **计算优化**：降低特征点搜索密度，减少计算负载
- **帧率控制**：200ms间隔处理，平衡性能和实时性

## 文件结构

```
main/
├── optical_flow.h          # 光流算法头文件
├── optical_flow.c          # 光流算法实现
├── 01_camera_for_trac.c    # 主程序（已集成光流）
├── camera_color_detection.h # 色块检测头文件
├── camera_color_detection.c # 色块检测实现
└── CMakeLists.txt          # 构建配置（已更新）
```

## 核心功能

### 1. 光流跟踪器初始化
```c
optical_flow_tracker_t tracker;
optical_flow_init(&tracker, 320, 240);
```

### 2. 特征点检测
- 使用Harris角点检测器
- 自动筛选高质量特征点
- 支持动态特征点更新

### 3. 光流计算
- Lucas-Kanade方法计算像素运动
- 实时估计运动方向和幅度
- 提供运动置信度评估

### 4. 舵机控制
- 根据光流运动自动调整舵机角度
- 运动补偿算法，实现稳定跟踪
- 平滑的角度过渡

## 使用方法

### 编译和烧录
```bash
cd /home/cra/workplace_esp32/Komeiji_Satori/01_camera_for_trac
idf.py build
idf.py flash monitor
```

### 运行模式

#### 正常模式（混合跟踪）
- 系统启动后自动进入混合跟踪模式
- 优先检测红色和绿色色块
- 当没有检测到色块时，自动启用光流跟踪
- 实时显示跟踪状态和舵机角度

#### 测试模式
- 在代码中定义`TEST_MODE`宏
- 运行舵机测试和光流算法测试
- 验证各组件功能

### 调试信息

系统会输出以下调试信息：

```
光流跟踪器初始化成功，图像尺寸: 320x240
检测到 15 个角点特征
运动估计: dx=2.34, dy=-1.67, 跟踪点数=12, 置信度=0.75
光流跟踪: 运动(2.34,-1.67) -> 舵机角度(88,92), 置信度=0.75
```

## 参数调整

### 光流算法参数
在`optical_flow.h`中可以调整以下参数：

```c
#define MAX_FEATURES 50        // 最大特征点数量
#define WINDOW_SIZE 5          // 光流计算窗口大小
#define MIN_EIGENVALUE 1000.0f // 最小特征值阈值
```

### 运动跟踪参数
在主程序中可以调整：

```c
float motion_scale = 0.5f;     // 运动缩放因子
float confidence_threshold = 0.3f; // 置信度阈值
```

## 性能指标

- **处理帧率**：约5FPS（200ms间隔）
- **特征点数量**：10-50个（动态调整）
- **内存使用**：约150KB（320x240图像）
- **CPU使用率**：中等（优化后）

## 应用场景

1. **运动物体跟踪**：跟踪移动的目标物体
2. **相机稳定**：补偿相机抖动
3. **手势识别**：检测手部运动模式
4. **机器人导航**：视觉里程计
5. **安防监控**：运动检测报警

## 注意事项

1. **光照条件**：算法对光照变化敏感，建议在稳定光照下使用
2. **运动速度**：过快的运动可能导致跟踪失败
3. **纹理要求**：需要足够的图像纹理来检测特征点
4. **内存限制**：确保ESP32有足够的可用内存

## 故障排除

### 常见问题

1. **光流跟踪器初始化失败**
   - 检查内存是否充足
   - 确认图像尺寸参数正确

2. **检测不到特征点**
   - 检查图像是否有足够纹理
   - 调整`MIN_EIGENVALUE`阈值

3. **跟踪不稳定**
   - 调整`motion_scale`参数
   - 增加置信度阈值

4. **性能问题**
   - 减少最大特征点数量
   - 增加处理间隔时间

## 扩展功能

未来可以考虑添加的功能：

1. **多尺度光流**：支持图像金字塔
2. **运动预测**：基于历史数据预测运动
3. **自适应阈值**：根据环境自动调整参数
4. **深度学习集成**：结合CNN进行特征提取

## 技术支持

如有问题，请检查：
1. ESP-IDF版本兼容性
2. 硬件连接是否正确
3. 内存配置是否充足
4. 编译选项是否正确